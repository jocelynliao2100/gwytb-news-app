import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import altair as alt
import matplotlib.pyplot as plt
import re
from collections import defaultdict
from docx import Document
from io import BytesIO
from datetime import datetime

def render_exchange_analysis():
    uploaded_file = st.file_uploader("ğŸ“‚ è«‹ä¸Šå‚³äº¤å¾€äº¤æµåŸå§‹ Word æª”æ¡ˆï¼ˆå« HTML çµæ§‹ï¼‰", type="docx")

    if uploaded_file:
        st.title("ğŸŒ äº¤å¾€äº¤æµæ¬„ç›®åˆ†æ")
        doc = Document(uploaded_file)
        paragraphs = [p.text.strip() for p in doc.paragraphs if p.text.strip()]

        titles = [line for line in paragraphs if re.match(r"^\[ ?20\d{2}-\d{2}-\d{2} ?\]", line) or re.search(r"[\u4e00-\u9fff]{4,}", line)]

        categories = {
            "é’å¹´äº¤æµ": ["é’å¹´", "å­¦ç”Ÿ", "å®ä¹ ", "ç ”å­¦è¥", "äº¤æµæœˆ", "å†¬ä»¤è¥", "ä½“è‚²è¥", "èŒåœº", "é’åˆ›", "æ‰“å¡"],
            "æ–‡åŒ–å®—æ•™": ["æ–‡åŒ–", "ç¥­ç¥–", "è¯—è¯", "ä¹¦ç”»", "è®ºè¯­", "æ–‡æ˜Œ", "å¤§ç¦¹", "ç¥å†œ", "å«˜ç¥–", "é»„å¸", "æ±‰æœ"],
            "ç¯€æ…¶æ°‘ä¿—": ["å…ƒå®µ", "æ˜¥èŠ‚", "å¹´å‘³", "ä¸­ç§‹", "æ˜¥èŒ¶", "ä¸‰æœˆä¸‰", "è”è°Š", "ç¯ç«", "éé—"],
            "ç¶“è²¿ç”¢æ¥­": ["æ‹›å•†", "ç»è´¸", "äº§ä¸š", "åˆä½œ", "é‡‘è", "é“¾", "åº§è°ˆ", "è¥å•†", "å‘å±•"],
            "åœ°æ–¹ç¤¾å€": ["å‚è®¿", "æ…°é—®", "æœåŠ¡å¹³å°", "å»ºæ¡¥", "æ¡ä¾‹", "æ³•", "å®£ä¼ ", "æ™®æ³•", "è¿å¿ƒ"],
            "é«”è‚²è—è¡“": ["ç¯®çƒ", "è¡—èˆ", "æ‚æŠ€", "ä¹¦ç”»", "è‰ºæœ¯", "æ¼”å‡º"]
        }

        def classify(title):
            for cat, kw_list in categories.items():
                if any(kw in title for kw in kw_list):
                    return cat
            return "æœªåˆ†é¡"

        stat = defaultdict(int)
        detail_rows = []
        for title in titles:
            cat = classify(title)
            stat[cat] += 1
            if cat != "æœªåˆ†é¡":
                detail_rows.append((cat, title))

        df_summary = pd.DataFrame(stat.items(), columns=["é¡åˆ¥", "æ•¸é‡"]).sort_values("æ•¸é‡", ascending=False)
        df_detail = pd.DataFrame(detail_rows, columns=["åˆ†é¡", "æ¨™é¡Œ"]).sort_values("åˆ†é¡")

        st.markdown("### ğŸ¯ å…­é¡æ´»å‹•é¡åˆ¥çµ±è¨ˆ")
        st.dataframe(df_summary)

        st.markdown("### ğŸ“° æ´»å‹•æ¨™é¡Œå½™æ•´ï¼ˆä¾åˆ†é¡ï¼‰")
        for cat in df_detail["åˆ†é¡"].unique():
            with st.expander(f"{cat} çš„æ´»å‹•æ¨™é¡Œ"):
                for t in df_detail[df_detail["åˆ†é¡"] == cat]["æ¨™é¡Œ"]:
                    st.markdown(f"- {t}")

        st.markdown("### ğŸ“ ä¸­åœ‹åœ°åç†±é»åœ–")
        data = {
            "åœ°ç‚¹": [
                "è´µå·", "æˆéƒ½", "å››å·", "æ­¦æ±‰", "é‡åº†", "å¹¿ä¸œ", "ç¦å»º", "ç æµ·", "å¹¿å·", "é’å²›", "å—äº¬", "ä¸œè",
                "å±±ä¸œ", "æ¹–åŒ—", "æ±Ÿè¥¿", "å¹¿è¥¿", "åŒ—äº¬", "æ²³å—", "æµå—", "æ–°ç–†", "æ±•å°¾", "æ­å·", "æ±Ÿè‹", "æµ™æ±Ÿ",
                "ä¸Šæµ·", "æ²ˆé˜³", "å¦é—¨", "æ±•å¤´", "ç¦å·", "å¤§è¿", "åˆè‚¥", "å®‰å¾½", "ç»µé˜³", "æ·±åœ³", "æ¹›æ±Ÿ", "æ˜†å±±",
                "ä½›å±±", "é»‘é¾™æ±Ÿ", "æ²³åŒ—", "æ½®å·", "è‹å·", "è´µé˜³", "éƒ‘å·", "é¦™æ¸¯", "ç”˜è‚ƒ", "æ¢…å·", "æƒ å·", "æ¸©å·",
                "å—å®", "å“ˆå°”æ»¨", "é™•è¥¿", "æ´›é˜³", "å—æ²™", "å¹³æ½­", "æ¼³å·", "æµ·å—", "è¥¿æ¹–", "æ½®æ±•", "å—æ˜Œ"
            ],
            "æ¬¡æ•°": [
                289, 260, 232, 226, 225, 202, 174, 160, 157, 155, 133, 132,
                123, 109, 108, 108, 105, 97, 90, 89, 87, 85, 84, 75,
                68, 67, 57, 57, 57, 48, 47, 45, 43, 40, 40, 40,
                38, 36, 35, 33, 33, 32, 32, 31, 31, 30, 25, 24,
                21, 21, 21, 19, 19, 19, 19, 19, 18, 17, 16
            ]
        }

        location_data = {
            "è´µå·": (106.8748, 26.8154), "æˆéƒ½": (104.0665, 30.5726), "å››å·": (102.7098, 30.6171),
            "æ­¦æ±‰": (114.2986, 30.5844), "é‡åº†": (106.5516, 29.5630), "å¹¿ä¸œ": (113.2644, 23.1291),
            "ç¦å»º": (119.2965, 26.0745), "ç æµ·": (113.5767, 22.2707), "å¹¿å·": (113.2644, 23.1291),
            "é’å²›": (120.3826, 36.0671), "å—äº¬": (118.7969, 32.0617), "ä¸œè": (113.7518, 23.0207),
            "å±±ä¸œ": (117.0204, 36.6683), "æ¹–åŒ—": (114.3419, 30.5467), "æ±Ÿè¥¿": (115.8582, 28.6832),
            "å¹¿è¥¿": (108.3275, 22.8150), "åŒ—äº¬": (116.4074, 39.9042), "æ²³å—": (113.6654, 34.7570),
            "æµå—": (117.1200, 36.6512), "æ–°ç–†": (87.6168, 43.8256), "æ±•å°¾": (115.3753, 22.7862),
            "æ­å·": (120.1551, 30.2741), "æ±Ÿè‹": (118.7632, 32.0617), "æµ™æ±Ÿ": (120.1536, 30.2656),
            "ä¸Šæµ·": (121.4737, 31.2304), "æ²ˆé˜³": (123.4315, 41.8057), "å¦é—¨": (118.0895, 24.4798),
            "æ±•å¤´": (116.6822, 23.3535), "ç¦å·": (119.2965, 26.0745), "å¤§è¿": (121.6147, 38.9140),
            "åˆè‚¥": (117.2272, 31.8206), "å®‰å¾½": (117.2849, 31.8616), "ç»µé˜³": (104.6796, 31.4675),
            "æ·±åœ³": (114.0579, 22.5431), "æ¹›æ±Ÿ": (110.3589, 21.2713), "æ˜†å±±": (120.9807, 31.3856),
            "ä½›å±±": (113.1214, 23.0215), "é»‘é¾™æ±Ÿ": (126.6424, 45.7560), "æ²³åŒ—": (114.5025, 38.0455),
            "æ½®å·": (116.6323, 23.6618), "è‹å·": (120.5853, 31.2983), "è´µé˜³": (106.6302, 26.6477),
            "éƒ‘å·": (113.6254, 34.7466), "é¦™æ¸¯": (114.1694, 22.3193), "ç”˜è‚ƒ": (103.8264, 36.0594),
            "æ¢…å·": (116.1176, 24.2991), "æƒ å·": (114.4168, 23.1115), "æ¸©å·": (120.6994, 27.9938),
            "å—å®": (108.3669, 22.8170), "å“ˆå°”æ»¨": (126.5349, 45.8038), "é™•è¥¿": (108.9542, 34.2655),
            "æ´›é˜³": (112.4536, 34.6197), "å—æ²™": (113.5958, 22.7855), "å¹³æ½­": (119.7912, 25.5035),
            "æ¼³å·": (117.6536, 24.5130), "æµ·å—": (110.3486, 20.0174), "è¥¿æ¹–": (120.1410, 30.2400),
            "æ½®æ±•": (116.6822, 23.3535), "å—æ˜Œ": (115.8582, 28.6832)
        }

        df_map = pd.DataFrame(data)
        df_map["lon"] = df_map["åœ°ç‚¹"].map(lambda x: location_data.get(x, (None, None))[0])
        df_map["lat"] = df_map["åœ°ç‚¹"].map(lambda x: location_data.get(x, (None, None))[1])
        df_map = df_map.dropna()

        fig = go.Figure(data=go.Scattergeo(
            lon=df_map['lon'],
            lat=df_map['lat'],
            text=df_map['åœ°ç‚¹'] + ": " + df_map['æ¬¡æ•°'].astype(str) + " æ¬¡",
            mode='markers',
            marker=dict(
                size=df_map['æ¬¡æ•°'] / 10,
                color=df_map['æ¬¡æ•°'],
                colorscale='Reds',
                opacity=0.8,
                colorbar=dict(title="å‡ºç¾æ¬¡æ•¸")
            ),
        ))

        fig.update_layout(
            title_text='ä¸­åœ‹æ–°èåœ°åç†±é»åœ–',
            geo=dict(
                scope='asia',
                showland=True,
                landcolor="LightGreen",
                showocean=True,
                oceancolor="LightBlue",
                projection_type='natural earth'
            ),
            height=700
        )

        st.plotly_chart(fig, use_container_width=True)
    else:
        st.info("è«‹ä¸Šå‚³ Word æª”æ¡ˆé€²è¡Œåˆ†æã€‚")
